================================================================================
GASTRIC-MOTION SYNCHRONY ANALYSIS PIPELINE
From Raw Data to FDR-Corrected Population & Individual-Level Significance
================================================================================

STEP 1: DATA ACQUISITION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    ┌─────────────────┐                      ┌─────────────────┐
    │   EGG Data      │                      │   BOLD Data     │
    │  (Raw Gastric)  │                      │   (fMRI scans)  │
    └────────┬────────┘                      └────────┬────────┘
             │                                        │
             │ Surface electrodes                     │ 3T Scanner
             │ on abdomen                             │ TR = 2s
             │                                        │
             ▼                                        ▼
    ┌─────────────────┐                      ┌─────────────────┐
    │ Cardiac Artifact│                      │   fMRIprep      │
    │    Removal      │                      │  Preprocessing  │
    └────────┬────────┘                      └────────┬────────┘
             │                                        │
             │ Strict QC                              │ Motion correction
             │                                        │ Normalization
             ▼                                        ▼
    ┌─────────────────┐                      ┌─────────────────┐
    │ Clean EGG Signal│                      │  Head Motions   │
    │   (μV vs time)  │                      │  6 parameters:  │
    │                 │                      │  trans_x, y, z  │
    │ Sample rate:    │                      │  rot_x, y, z    │
    │ 1000 Hz         │                      │                 │
    └────────┬────────┘                      └────────┬────────┘
             │                                        │
             │                                        │
             ▼                                        ▼


STEP 2: SPECTRAL ANALYSIS & FREQUENCY-SPECIFIC FILTERING
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    ┌─────────────────┐
    │Power Spectral   │
    │   Density       │
    │   (Welch)       │
    └────────┬────────┘
             │
             │ Identify subject-specific
             │ gastric peak frequency
             │ (normogastric: 0.033-0.066 Hz)
             ▼
    ┌─────────────────┐
    │  Peak Frequency │
    │   f_gastric     │◄─────────────────────┐
    │  (e.g., 0.05 Hz)│                      │
    └────────┬────────┘                      │
             │                                │
             │                                │
             ├────────────────────────────────┤
             │                                │
             ▼                                ▼
    ┌─────────────────┐              ┌─────────────────┐
    │Gastric Bandpass │              │Motion Bandpass  │
    │     Filter      │              │     Filter      │
    │                 │              │                 │
    │f_gastric ± 0.015│◄─────────────┤f_gastric ± 0.015│
    │                 │  Dashed link │                 │
    │ FIR, Hamming    │  (same freq) │ FIR, Hamming    │
    │ window          │              │ window          │
    │ Zero-phase      │              │ Zero-phase      │
    └────────┬────────┘              └────────┬────────┘
             │                                │
             │ Resample to 10 Hz              │ Already at fMRI
             │ (intermediate_sample_rate)     │ sample rate (0.5 Hz)
             ▼                                ▼
    ┌─────────────────┐              ┌─────────────────┐
    │Filtered Gastric │              │Filtered Motion  │
    │    Signal       │              │  (6 parameters) │
    │ G(t) @ 10 Hz    │              │ M_i(t) @ 0.5 Hz │
    └────────┬────────┘              └────────┬────────┘
             │                                │
             │ Resample to fMRI rate          │
             │ (0.5 Hz for alignment)         │
             ▼                                ▼
    ┌─────────────────┐              ┌─────────────────┐
    │Aligned Gastric  │              │Aligned Motion   │
    │  G(t) @ 0.5 Hz  │              │ M_i(t) @ 0.5 Hz │
    └────────┬────────┘              └────────┬────────┘
             │                                │
             │                                │
             ▼                                ▼


STEP 3: HILBERT TRANSFORM & INSTANTANEOUS PHASE/AMPLITUDE EXTRACTION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    ┌─────────────────┐              ┌─────────────────┐
    │Hilbert Transform│              │Hilbert Transform│
    │   on Gastric    │              │   on Motion     │
    └────────┬────────┘              └────────┬────────┘
             │                                │
             │ Analytic signal                │ Analytic signal
             │                                │
             ├────────────┬───────────        ├────────────┬───────────
             ▼            ▼                   ▼            ▼
    ┌────────────┐ ┌────────────┐   ┌────────────┐ ┌────────────┐
    │  Gastric   │ │  Gastric   │   │  Motion    │ │  Motion    │
    │ Envelope   │ │   Phase    │   │ Envelope   │ │   Phase    │
    │            │ │            │   │            │ │            │
    │  A_g(t)    │ │  φ_g(t)    │   │  A_m(t)    │ │  φ_m(t)    │
    └────────────┘ └────────┬───┘   └────────────┘ └────────┬───┘
          │                 │              │                 │
          │                 │              │                 │
          │                 │              │                 │
          │                 └──────┬───────┘                 │
          │                        │                         │
          │                        ▼                         │
          │               ┌─────────────────┐               │
          │               │ Phase Difference│               │
          │               │                 │               │
          │               │ Δφ(t) = φ_m(t) -│               │
          │               │         φ_g(t)  │               │
          │               └────────┬────────┘               │
          │                        │                         │
          │                        │                         │
          └────────────────────────┼─────────────────────────┘
                                   │
                                   ▼


STEP 4: SYNCHRONY COMPUTATION (PLV & awPLV)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    ┌─────────────────────────────────────────────────────────────────┐
    │                  PHASE LOCKING VALUE (PLV)                      │
    │                                                                 │
    │                         ┌──  T          ─┐                      │
    │                         │  ──            │                      │
    │         PLV = │ 1/T  Σ  │ e^(iΔφ(t))   │ │                     │
    │                         │               │ │                     │
    │                         └─  t=1         ─┘                      │
    │                                                                 │
    │  where:                                                         │
    │    - T = total number of time points                            │
    │    - Δφ(t) = instantaneous phase difference                     │
    │    - | · | = absolute value (modulus)                           │
    │    - Range: [0, 1]                                              │
    │    - 0 = no phase locking, 1 = perfect phase locking            │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                        ┌────────────────────┐
                        │   PLV Empirical    │
                        │   (per subject,    │
                        │    run, motion     │
                        │    parameter)      │
                        └──────────┬─────────┘
                                   │
                                   │
    ┌─────────────────────────────────────────────────────────────────┐
    │          AMPLITUDE-WEIGHTED PLV (awPLV)                         │
    │                                                                 │
    │                       ┌──  T                    ─┐              │
    │                       │  ──                      │              │
    │      awPLV = │ 1/T  Σ │ w(t) · e^(iΔφ(t))      │ │             │
    │                       │                         │ │             │
    │                       └─  t=1                   ─┘              │
    │                                                                 │
    │  where the weight function is:                                  │
    │                                                                 │
    │              w(t) = A_g(t) · A_m(t)                             │
    │                     ─────────────────                           │
    │                      Σ A_g(τ) · A_m(τ)                          │
    │                      τ                                          │
    │                                                                 │
    │  where:                                                         │
    │    - A_g(t) = gastric envelope (amplitude)                      │
    │    - A_m(t) = motion envelope (amplitude)                       │
    │    - w(t) is normalized such that Σw(t) = 1                     │
    │    - Range: [0, 1]                                              │
    │    - Emphasizes high-amplitude coupling periods                 │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                        ┌────────────────────┐
                        │  awPLV Empirical   │
                        │   (per subject,    │
                        │    run, motion     │
                        │    parameter)      │
                        └──────────┬─────────┘
                                   │
                                   ▼


STEP 5: MISMATCH NULL DISTRIBUTION GENERATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    For each subject-run's motion parameter:

    ┌─────────────────────────────────────────────────────────────────┐
    │  Subject A, Run 1, Motion Parameter: trans_x                    │
    │                                                                 │
    │  Empirical:                                                     │
    │    PLV(Gastric_A_run1, Motion_A_run1_trans_x)                   │
    │    awPLV(Gastric_A_run1, Motion_A_run1_trans_x)                 │
    │                                                                 │
    │  Null Distribution (N-1 mismatch pairings):                     │
    │    PLV(Gastric_B_run1, Motion_A_run1_trans_x)                   │
    │    PLV(Gastric_C_run1, Motion_A_run1_trans_x)                   │
    │    PLV(Gastric_D_run2, Motion_A_run1_trans_x)                   │
    │    ...                                                          │
    │    PLV(Gastric_Z_run2, Motion_A_run1_trans_x)                   │
    │                                                                 │
    │    awPLV(Gastric_B_run1, Motion_A_run1_trans_x)                 │
    │    awPLV(Gastric_C_run1, Motion_A_run1_trans_x)                 │
    │    ...                                                          │
    │                                                                 │
    │  → N_null samples for PLV (typically 82-83 per subject-run)     │
    │  → N_null samples for awPLV (typically 82-83 per subject-run)   │
    │                                                                 │
    │  Null Hypothesis: No subject-specific gastric-motion coupling   │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                        ┌────────────────────┐
                        │  Null Distributions│
                        │                    │
                        │  PLV_null array    │
                        │  awPLV_null array  │
                        │                    │
                        │  (per subject-run, │
                        │   motion param)    │
                        └──────────┬─────────┘
                                   │
                                   ▼


STEP 6: INDIVIDUAL-LEVEL STATISTICAL TESTING
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    For each subject-run and motion parameter (N = 84 runs × 6 params = 504):

    ┌─────────────────────────────────────────────────────────────────┐
    │  Individual P-value Calculation:                                │
    │                                                                 │
    │  p_PLV = proportion of null PLV values ≥ empirical PLV          │
    │        = #{PLV_null ≥ PLV_empirical} / N_null                   │
    │                                                                 │
    │  p_awPLV = proportion of null awPLV values ≥ empirical awPLV    │
    │          = #{awPLV_null ≥ awPLV_empirical} / N_null             │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │  Multiple Comparison Correction (Individual Level):             │
    │                                                                 │
    │  SEPARATE corrections for PLV and awPLV (504 tests each):       │
    │                                                                 │
    │  1. FDR Correction (Benjamini-Hochberg):                        │
    │     - Input: All 504 p-values for PLV                           │
    │     - Output: q-values (FDR-corrected p-values)                 │
    │     - Threshold: q < 0.05                                       │
    │     - sig_fdr_plv = (q_PLV < 0.05)                              │
    │                                                                 │
    │     - Input: All 504 p-values for awPLV                         │
    │     - Output: q-values (FDR-corrected p-values)                 │
    │     - Threshold: q < 0.05                                       │
    │     - sig_fdr_awplv = (q_awPLV < 0.05)                          │
    │                                                                 │
    │  2. Bonferroni Correction (conservative):                       │
    │     - p_bonf_plv = min(p_PLV × 6, 1.0)                          │
    │     - sig_bonf_plv = (p_bonf_plv < 0.05)                        │
    │                                                                 │
    │     - p_bonf_awplv = min(p_awPLV × 6, 1.0)                      │
    │     - sig_bonf_awplv = (p_bonf_awplv < 0.05)                    │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                        ┌────────────────────┐
                        │ INDIVIDUAL RESULTS │
                        │                    │
                        │ PLV FDR sig:       │
                        │   22/504 (4.4%)    │
                        │                    │
                        │ awPLV FDR sig:     │
                        │   30/504 (6.0%)    │
                        │                    │
                        └──────────┬─────────┘
                                   │
                                   │
                                   ▼


STEP 7: POPULATION-LEVEL STATISTICAL TESTING
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    For each motion parameter (6 total) and each metric (PLV, awPLV):

    ┌─────────────────────────────────────────────────────────────────┐
    │  Population-Level Test (Mann-Whitney U):                        │
    │                                                                 │
    │  Question: Does population empirical synchrony exceed chance?   │
    │                                                                 │
    │  For trans_x and PLV:                                           │
    │    - Empirical distribution: [PLV values from 84 runs]          │
    │    - Null distribution: [pooled PLV_null from all 84 runs]      │
    │      (N_null ≈ 84 × 82 = 6,882 null samples)                    │
    │                                                                 │
    │    - Test: Mann-Whitney U (one-sided: empirical > null)         │
    │    - Statistic: U = 329,183                                     │
    │    - p-value = 0.0142                                           │
    │                                                                 │
    │  Effect Size:                                                   │
    │    ES = mean(empirical) - mean(null)                            │
    │       = 0.184 - 0.162 = 0.021                                   │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │  Multiple Comparison Correction (Population Level):             │
    │                                                                 │
    │  SEPARATE corrections for PLV and awPLV (6 motion params each): │
    │                                                                 │
    │  PLV Analysis (6 tests):                                        │
    │    - Raw p-values: [p_trans_x, p_trans_y, ..., p_rot_z]         │
    │    - FDR correction (Benjamini-Hochberg, q < 0.05)              │
    │    - Bonferroni correction (p × 6 < 0.05)                       │
    │                                                                 │
    │  awPLV Analysis (6 tests):                                      │
    │    - Raw p-values: [p_trans_x, p_trans_y, ..., p_rot_z]         │
    │    - FDR correction (Benjamini-Hochberg, q < 0.05)              │
    │    - Bonferroni correction (p × 6 < 0.05)                       │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                        ┌────────────────────┐
                        │ POPULATION RESULTS │
                        │                    │
                        │ PLV FDR sig:       │
                        │   4/6 parameters   │
                        │   (trans_x, trans_y│
                        │    rot_x, rot_y)   │
                        │                    │
                        │ awPLV FDR sig:     │
                        │   5/6 parameters   │
                        │   (trans_x, trans_y│
                        │    rot_x, rot_y,   │
                        │    rot_z)          │
                        │                    │
                        │ Non-significant:   │
                        │   trans_z (both)   │
                        │                    │
                        └────────────────────┘


STEP 8: FINAL OUTPUT & VISUALIZATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    ┌─────────────────────────────────────────────────────────────────┐
    │  Output Files:                                                  │
    │                                                                 │
    │  1. plvs_egg_w_motion_v5.csv                                    │
    │     - Individual-level results (504 rows)                       │
    │     - Columns: subject, run, motion_param                       │
    │       plv_empirical, plv_null_mean, plv_null_std,               │
    │       p_value_plv, p_fdr_plv, p_bonf_plv,                       │
    │       sig_fdr_plv, sig_bonf_plv,                                │
    │       awplv_empirical, awplv_null_mean, awplv_null_std,         │
    │       p_value_awplv, p_fdr_awplv, p_bonf_awplv,                 │
    │       sig_fdr_awplv, sig_bonf_awplv                             │
    │                                                                 │
    │  2. population_level_v5.csv                                     │
    │     - Population-level results (12 rows = 6 params × 2 metrics) │
    │     - Columns: motion_param, metric, n_empirical, n_null,       │
    │       mean_empirical, std_empirical, mean_null, std_null,       │
    │       effect_size, mann_whitney_u, p_value, p_fdr, p_bonf,      │
    │       sig_fdr, sig_bonf                                         │
    │                                                                 │
    │  3. egg_confounds_synchrony_v5.png                              │
    │     - 3×2 nested grid visualization                             │
    │     - Each cell contains PLV and awPLV density plots            │
    │     - Empirical (filled) vs Null (dashed) distributions         │
    │     - Significance markers: * (q<0.05), ** (q<0.01), *** (q<0.001)│
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘


================================================================================
KEY FINDINGS SUMMARY
================================================================================

POPULATION LEVEL (FDR-corrected, q < 0.05):

  PLV Significant (4/6):
    ✓ Translation X (Left-Right):        ES = 0.021, q = 0.021
    ✓ Translation Y (Ant-Post):          ES = 0.042, q = 0.001  ★ Strongest
    ✓ Rotation X (Pitch):                ES = 0.030, q = 0.010
    ✓ Rotation Y (Roll):                 ES = 0.033, q = 0.003
    ✗ Rotation Z (Yaw):                  ES = 0.020, q = 0.071  (marginal)
    ✗ Translation Z (Sup-Inf):           ES = -0.007, q = 0.852 (no coupling)

  awPLV Significant (5/6):
    ✓ Translation X (Left-Right):        ES = 0.044, q = 0.002
    ✓ Translation Y (Ant-Post):          ES = 0.059, q = 0.002  ★ Strongest
    ✓ Rotation X (Pitch):                ES = 0.049, q = 0.004
    ✓ Rotation Y (Roll):                 ES = 0.043, q = 0.010
    ✓ Rotation Z (Yaw):                  ES = 0.045, q = 0.012
    ✗ Translation Z (Sup-Inf):           ES = 0.007, q = 0.434  (no coupling)

INDIVIDUAL LEVEL (FDR-corrected, q < 0.05):
  - PLV:   22/504 tests significant (4.4%)
  - awPLV: 30/504 tests significant (6.0%)

INTERPRETATION (I am not Sure, based on my brief understanding):
  Gastric rhythm significantly modulates head motion in anterior-posterior,
  lateral, pitch, and roll dimensions. Superior-inferior motion shows NO
  coupling. Amplitude-weighted analysis reveals stronger effects, suggesting
  coupling is particularly prominent during high-amplitude gastric oscillations.

================================================================================
END OF PIPELINE
================================================================================

